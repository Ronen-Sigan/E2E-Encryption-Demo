<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2E Encryption Demo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }
        .section {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .btn {
            background-image: linear-gradient(to right, #4c51bf, #667eea);
            color: #ffffff;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background-image: none;
            background-color: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-jane {
            background-image: linear-gradient(to right, #ec4899, #f472b6);
        }
        .btn-jane:hover {
            box-shadow: 0 5px 15px rgba(244, 114, 182, 0.4);
        }
        .btn-neutral {
            background-image: linear-gradient(to right, #6b7280, #9ca3af);
        }
        .btn-neutral:hover {
            box-shadow: 0 5px 15px rgba(156, 163, 175, 0.4);
        }
        .message-box {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }

        /* Animation specific styles */
        #animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f4f8;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }
        .animation-step {
            display: none;
        }
        .animation-step.active {
            display: block;
        }
        .fade-in {
            animation: fadeIn 1.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fly-in-left {
            animation: flyInLeft 1s ease-out forwards;
        }
        .fly-in-right {
            animation: flyInRight 1s ease-out forwards;
        }
        @keyframes flyInLeft {
            from { transform: translateX(-100vw); }
            to { transform: translateX(0); }
        }
        @keyframes flyInRight {
            from { transform: translateX(100vw); }
            to { transform: translateX(0); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        #key-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 5s forwards;
        }
        @keyframes dash {
            to { stroke-dashoffset: 0; }
        }
        #encrypted-message-icon {
            transition: all 1s ease-in-out;
        }
        .pulse-once {
            animation: pulse-once 1s ease-in-out;
        }
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Animation Container -->
    <div id="animation-container" class="hidden">
        <h1 id="animation-title" class="text-4xl font-extrabold text-gray-900 mb-6"></h1>
        <p id="animation-subtitle" class="text-xl text-gray-600 mb-12 max-w-xl"></p>
        
        <div id="animation-step-1" class="animation-step">
            <div class="flex items-center justify-center space-x-8">
                <div class="flex flex-col items-center">
                    <i class="fas fa-lock text-5xl text-blue-500 fly-in-left"></i>
                    <p class="mt-2 text-gray-700 font-bold">Joe's Private Key</p>
                </div>
                <div class="text-5xl text-gray-400 opacity-0 transition-opacity duration-1000" id="plus-icon-1">+</div>
                <div class="flex flex-col items-center">
                    <i class="fas fa-lock-open text-5xl text-purple-500 fly-in-right"></i>
                    <p class="mt-2 text-gray-700 font-bold">Jane's Public Key</p>
                </div>
            </div>
            <div class="text-4xl text-gray-500 mt-8 opacity-0 transition-opacity duration-1000" id="equals-icon-1">=</div>
            <div class="flex flex-col items-center mt-8 opacity-0 transition-opacity duration-1000" id="secret-key-icon-1">
                <i class="fas fa-key text-6xl text-green-500 pulse"></i>
                <p class="mt-2 text-gray-700 font-bold">Shared Secret</p>
            </div>
        </div>

        <div id="animation-step-2" class="animation-step">
            <div class="flex items-center justify-center space-x-12">
                <div class="flex flex-col items-center">
                    <i class="fas fa-user-secret text-6xl text-indigo-500 pulse-once"></i>
                    <p class="mt-2 text-gray-700 font-bold">Joe</p>
                </div>
                <div class="relative w-96 h-24">
                    <div class="absolute w-full h-full flex items-center justify-center">
                        <i class="fas fa-comment text-6xl text-gray-500 absolute z-10 pulse-once"></i>
                        <i id="encrypted-message-icon" class="fas fa-lock text-5xl text-yellow-500 absolute opacity-0 scale-0 z-20"></i>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <i class="fas fa-user-tie text-6xl text-pink-500 pulse-once"></i>
                    <p class="mt-2 text-gray-700 font-bold">Jane</p>
                </div>
            </div>
        </div>

        <div id="animation-step-3" class="animation-step">
            <i class="fas fa-key text-6xl text-green-500 pulse-once"></i>
            <p class="mt-4 text-gray-700 text-2xl font-bold">Shared Secret Key</p>
        </div>
        
        <div id="animation-step-4" class="animation-step">
            <i class="fas fa-shield-alt text-6xl text-blue-500 pulse-once"></i>
            <p class="mt-4 text-gray-700 text-2xl font-bold">Complete!</p>
            <p class="text-xl text-gray-600 mt-2">The shared secret ensures your messages are safe.</p>
        </div>

        <button id="skip-btn" class="absolute bottom-10 right-10 text-gray-500 hover:text-gray-700 font-semibold px-4 py-2 rounded-lg transition-colors duration-200">
            End Animation
        </button>
    </div>

    <!-- Main Application Content (Initially Hidden) -->
    <div id="main-content" class="container space-y-10 hidden">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-gray-900 mb-4">üîê E2E Encryption Demo</h1>
        <p class="text-center text-gray-600 text-lg mb-8">
            This interactive demo simplifies end-to-end encryption for educational purposes, showing how two people can secretly agree on a shared key. For simplicity, random integers between 1 and 10 are used for these keys. This key is then used to scramble (encrypt) and unscramble (decrypt) private messages, ensuring only the intended recipient can read them.
        </p>
        
        <!-- Cryptography Explanations Section -->
        <div class="section">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">How the Encryption Works</h2>
            <div class="space-y-4 text-gray-600">
                <p>
                    This demo uses two simple cryptographic concepts:
                </p>
                <ul class="list-disc list-inside space-y-2">
                    <li>
                        <i>Diffie-Hellman Key Exchange (simplified):</i> This process allows two people, like Joe and Jane, to agree on a <b>shared secret</b> key over an insecure channel. Even if a third person sees the exchanged public values, they can't calculate the final shared secret because they don't have the private keys. Our demo uses a simple <i>mod 11</i> calculation to show how both sides can arrive at the same result independently.
                    </li>
                    <li>
                        <i>Vigen√®re-like Cipher:</i> This is a <b>substitution cipher</b> where each letter in the message is shifted by a different amount. The amount of the shift is determined by a **repeating key**. For example, if the key is '3', the first letter is shifted by 1, the second by 2, the third by 3, and the fourth letter is shifted by 1 again, repeating the pattern.
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Instructions Section -->
        <div class="section space-y-2">
            <h2 class="text-2xl font-bold text-gray-800">How to use this demo:</h2>
            <ol class="list-decimal list-inside space-y-1 text-gray-600">
                <li>Click <b>"Generate Keys"</b> for both Joe and Jane.</li>
                <li>Click <b>"Calculate Secret"</b> for both. You'll see they have the same secret!</li>
                <li>Type a message in Joe's text box and click <b>"Encrypt."</b></li>
                <li>Click <b>"Send to Jane."</b></li>
                <li>On Jane's side, click <b>"Decrypt"</b> to see the original message.</li>
                <li>Now, have Jane type a message, <b>"Encrypt"</b> it, and <b>"Send to Joe."</b></li>
                <li>On Joe's side, click <b>"Decrypt"</b> to read her message.</li>
                <li>To start over, simply refresh the page to generate new keys and try with new messages!</li>
            </ol>
        </div>
        
        <!-- Main Grid Container -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Joe's Section -->
            <div id="joe-section" class="section border-4 border-indigo-500">
                <h2 class="text-3xl font-bold text-indigo-700 mb-6">üë®‚Äçüíª Joe</h2>

                <!-- Step 1: Key Generation -->
                <div class="space-y-4 mb-8">
                    <h3 class="text-xl font-semibold text-gray-700">1. Generate Keys</h3>
                    <p class="text-gray-500">Joe secretly chooses a number and generates a public key from it.</p>
                    <div class="flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="joe-private-key">Private Key (Secret):</label>
                            <input type="number" id="joe-private-key" readonly class="bg-gray-100">
                        </div>
                        <button id="btn-joe-generate" class="btn btn-joe">Generate Keys</button>
                    </div>
                    <div class="input-group">
                        <label for="joe-public-key">Public Key (to share):</label>
                        <input type="text" id="joe-public-key" readonly class="bg-gray-100">
                    </div>
                </div>

                <!-- Step 2: Receive Public Key & Calculate Shared Secret -->
                <div class="space-y-4 mb-8">
                    <h3 class="text-xl font-semibold text-gray-700">2. Calculate Shared Secret</h3>
                    <p class="text-gray-500">Joe receives Jane's public key and combines it with his private key to create a shared secret.</p>
                    <div class="input-group">
                        <label for="joe-received-public-key">Received Public Key:</label>
                        <input type="text" id="joe-received-public-key" readonly class="bg-gray-100">
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="joe-shared-secret">Shared Secret:</label>
                            <input type="text" id="joe-shared-secret" readonly class="bg-gray-100">
                        </div>
                        <button id="btn-joe-calculate" class="btn btn-joe" disabled>Calculate Secret</button>
                    </div>
                </div>

                <!-- Step 3: Encrypt and Send Message -->
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold text-gray-700">3. Encrypt & Send Message</h3>
                    <p class="text-gray-500">Using the shared secret, Joe encrypts a message before sending it.</p>
                    <div class="input-group">
                        <label for="joe-message-input" class="flex justify-between items-center">
                            <span>Message to Encrypt:</span>
                            <span class="text-xs text-gray-500 italic">You can edit this text.</span>
                        </label>
                        <textarea id="joe-message-input" rows="2" placeholder="Type your secret message here..." class="resize-none focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="joe-encrypted-output">Encrypted Message:</label>
                            <textarea id="joe-encrypted-output" rows="2" readonly class="bg-gray-100 resize-none"></textarea>
                        </div>
                        <button id="btn-joe-encrypt" class="btn btn-joe">Encrypt</button>
                    </div>
                    <button id="btn-joe-send" class="btn btn-neutral w-full">Send to Jane</button>
                </div>
                
                <!-- Step 4: Decrypt Received Message -->
                <div class="space-y-4 mt-8">
                    <h3 class="text-xl font-semibold text-gray-700">4. Decrypt Message</h3>
                    <div class="input-group">
                        <label for="joe-received-encrypted">Received Encrypted Message:</label>
                        <textarea id="joe-received-encrypted" rows="2" readonly class="bg-gray-100 resize-none"></textarea>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="joe-decrypted-output">Decrypted Message:</label>
                            <textarea id="joe-decrypted-output" rows="2" readonly class="bg-gray-100 resize-none"></textarea>
                        </div>
                        <button id="btn-joe-decrypt" class="btn btn-joe">Decrypt</button>
                    </div>
                </div>
            </div>

            <!-- Jane's Section -->
            <div id="jane-section" class="section border-4 border-pink-500">
                <h2 class="text-3xl font-bold text-pink-700 mb-6">üë©‚Äçüíª Jane</h2>

                <!-- Step 1: Key Generation -->
                <div class="space-y-4 mb-8">
                    <h3 class="text-xl font-semibold text-gray-700">1. Generate Keys</h3>
                    <p class="text-gray-500">Jane secretly chooses a number and generates a public key from it.</p>
                    <div class="input-group flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="jane-private-key">Private Key (Secret):</label>
                            <input type="number" id="jane-private-key" readonly class="bg-gray-100">
                        </div>
                        <button id="btn-jane-generate" class="btn btn-jane">Generate Keys</button>
                    </div>
                    <div class="input-group">
                        <label for="jane-public-key">Public Key (to share):</label>
                        <input type="text" id="jane-public-key" readonly class="bg-gray-100">
                    </div>
                </div>

                <!-- Step 2: Receive Public Key & Calculate Shared Secret -->
                <div class="space-y-4 mb-8">
                    <h3 class="text-xl font-semibold text-gray-700">2. Calculate Shared Secret</h3>
                    <p class="text-gray-500">Jane receives Joe's public key and combines it with her private key to create a shared secret.</p>
                    <div class="input-group">
                        <label for="jane-received-public-key">Received Public Key:</label>
                        <input type="text" id="jane-received-public-key" readonly class="bg-gray-100">
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="jane-shared-secret">Shared Secret:</label>
                            <input type="text" id="jane-shared-secret" readonly class="bg-gray-100">
                        </div>
                        <button id="btn-jane-calculate" class="btn btn-jane" disabled>Calculate Secret</button>
                    </div>
                </div>

                <!-- Step 3: Encrypt and Send Message -->
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold text-gray-700">3. Encrypt & Send Message</h3>
                    <p class="text-gray-500">Using the shared secret, Jane encrypts a message before sending it.</p>
                    <div class="input-group">
                        <label for="jane-message-input" class="flex justify-between items-center">
                            <span>Message to Encrypt:</span>
                            <span class="text-xs text-gray-500 italic">You can edit this text.</span>
                        </label>
                        <textarea id="jane-message-input" rows="2" placeholder="Type your secret message here..." class="resize-none focus:ring-pink-500"></textarea>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="jane-encrypted-output">Encrypted Message:</label>
                            <textarea id="jane-encrypted-output" rows="2" readonly class="bg-gray-100 resize-none"></textarea>
                        </div>
                        <button id="btn-jane-encrypt" class="btn btn-jane">Encrypt</button>
                    </div>
                    <button id="btn-jane-send" class="btn btn-neutral w-full">Send to Joe</button>
                </div>

                <!-- Step 4: Decrypt Received Message -->
                <div class="space-y-4 mt-8">
                    <h3 class="text-xl font-semibold text-gray-700">4. Decrypt Message</h3>
                    <div class="input-group">
                        <label for="jane-received-encrypted">Received Encrypted Message:</label>
                        <textarea id="jane-received-encrypted" rows="2" readonly class="bg-gray-100 resize-none"></textarea>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="input-group flex-grow">
                            <label for="jane-decrypted-output">Decrypted Message:</label>
                            <textarea id="jane-decrypted-output" rows="2" readonly class="bg-gray-100 resize-none"></textarea>
                        </div>
                        <button id="btn-jane-decrypt" class="btn btn-jane">Decrypt</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Log -->
        <div class="section">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">System Log</h2>
            <div id="system-log" class="message-box text-gray-600 h-48 overflow-y-auto">
                <p>Welcome to the E2E Encryption Demo. Click the "Generate Keys" buttons to begin!</p>
            </div>
        </div>

    <!-- The Pop-up Modal UI -->
    <div id="popup-modal" class="modal">
        <div class="modal-content">
            <span id="popup-close-btn" class="modal-close-btn">&times;</span>
            <h3 id="popup-title" class="text-xl font-bold mb-2 text-gray-800"></h3>
            <p id="popup-message" class="text-gray-600"></p>
            <div id="popup-log"></div>
        </div>
    </div>

    <script>
        // --- Core Cryptography Simulation ---

        // WARNING: This is a simplified educational example and should NOT be used for real-world encryption.
        // The cryptographic methods here are simple to demonstrate the principles, not to provide security.
        
        // A smaller base number (g) and a prime modulus (p) for the simplified calculation.
        const PRIME_NUMBER_G = 7; 
        const PRIME_NUMBER_P = 11;

        /**
         * Generates a random integer between a minimum and maximum value (inclusive).
         * @param {number} min The minimum value.
         * @param {number} max The maximum value.
         * @returns {number} The random integer.
         */
        function generateRandomKey(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Simulates the generation of a public key from a private key using simple multiplication.
         * The simplified formula is: (g * private_key) mod p
         * @param {number} privateKey The secret number.
         * @returns {number} The public key.
         */
        function generatePublicKey(privateKey) {
            return (PRIME_NUMBER_G * privateKey) % PRIME_NUMBER_P;
        }

        /**
         * Simulates the calculation of a shared secret using simple multiplication.
         * The simplified formula is: (public_key_from_other_person * my_private_key) mod p
         * @param {number} otherPublicKey The public key from the other person.
         * @param {number} myPrivateKey My secret number.
         * @returns {number} The shared secret.
         */
        function calculateSharedSecret(otherPublicKey, myPrivateKey) {
            return (otherPublicKey * myPrivateKey) % PRIME_NUMBER_P;
        }

        /**
         * A simple Vigen√®re-like cipher that shifts each character by a dynamic amount
         * determined by its position and the shared secret key.
         * It shifts each alphabetical character by a number equal to the (position % key) + 1.
         * Other characters (numbers, symbols, spaces) are left unchanged.
         * @param {string} text The text to process.
         * @param {number} key The shared secret key (determines the max shift amount).
         * @param {boolean} decrypt Set to true for decryption.
         * @returns {string} The processed (encrypted or decrypted) text.
         */
        function vigenereCipher(text, key, decrypt = false) {
            let result = '';
            let alphabetIndex = 0;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char.match(/[a-z]/i)) {
                    const isUpperCase = char === char.toUpperCase();
                    const startCode = isUpperCase ? 'A'.charCodeAt(0) : 'a'.charCodeAt(0);
                    const originalCode = char.charCodeAt(0);
                    
                    // The shift is determined by the position in the message and the key
                    const shift = (alphabetIndex % key) + 1;
                    const finalShift = decrypt ? -shift : shift;
                    
                    let newCode = originalCode + finalShift;

                    // Handle wrap-around for alphabet
                    if (isUpperCase) {
                        if (newCode > 'Z'.charCodeAt(0)) {
                            newCode -= 26;
                        } else if (newCode < 'A'.charCodeAt(0)) {
                            newCode += 26;
                        }
                    } else {
                        if (newCode > 'z'.charCodeAt(0)) {
                            newCode -= 26;
                        } else if (newCode < 'a'.charCodeAt(0)) {
                            newCode += 26;
                        }
                    }
                    result += String.fromCharCode(newCode);
                    alphabetIndex++;
                } else {
                    // Don't encrypt non-alphabetic characters
                    result += char;
                }
            }
            return result;
        }

        // --- UI & State Management ---

        let joe = {
            privateKey: null,
            publicKey: null,
            sharedSecret: null,
            message: '',
            encryptedMessage: '',
            receivedEncrypted: '',
            decryptedMessage: ''
        };

        let jane = {
            privateKey: null,
            publicKey: null,
            sharedSecret: null,
            message: '',
            encryptedMessage: '',
            receivedEncrypted: '',
            decryptedMessage: ''
        };
        
        const log = (message) => {
            const logElement = document.getElementById('system-log');
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(p);
            logElement.scrollTop = logElement.scrollHeight; // Auto-scroll to the bottom
            return p.textContent;
        };

        // Pop-up Modal Functions
        const popupModal = document.getElementById('popup-modal');
        const popupTitle = document.getElementById('popup-title');
        const popupMessage = document.getElementById('popup-message');
        const popupLog = document.getElementById('popup-log');
        const popupCloseBtn = document.getElementById('popup-close-btn');

        const showPopup = (title, message, logMessage) => {
            popupTitle.textContent = title;
            popupMessage.textContent = message;
            popupLog.textContent = logMessage;
            popupModal.classList.add('show');
        };

        const hidePopup = () => {
            popupModal.classList.remove('show');
        };

        popupCloseBtn.addEventListener('click', hidePopup);
        // The automatic close on outside click has been removed per user request.

        // --- Event Listeners and Button Handlers ---
        
        const setupEventListeners = () => {
            // Joe's Actions
            const btnJoeGenerate = document.getElementById('btn-joe-generate');
            btnJoeGenerate.addEventListener('click', handleJoeGenerate);
            btnJoeGenerate.addEventListener('touchstart', (e) => { e.preventDefault(); handleJoeGenerate(); });
            document.getElementById('btn-joe-calculate').addEventListener('click', handleJoeCalculate);
            document.getElementById('btn-joe-encrypt').addEventListener('click', handleJoeEncrypt);
            document.getElementById('btn-joe-send').addEventListener('click', handleJoeSend);
            document.getElementById('btn-joe-decrypt').addEventListener('click', handleJoeDecrypt);
            
            // Jane's Actions
            const btnJaneGenerate = document.getElementById('btn-jane-generate');
            btnJaneGenerate.addEventListener('click', handleJaneGenerate);
            btnJaneGenerate.addEventListener('touchstart', (e) => { e.preventDefault(); handleJaneGenerate(); });
            document.getElementById('btn-jane-calculate').addEventListener('click', handleJaneCalculate);
            document.getElementById('btn-jane-encrypt').addEventListener('click', handleJaneEncrypt);
            document.getElementById('btn-jane-send').addEventListener('click', handleJaneSend);
            document.getElementById('btn-jane-decrypt').addEventListener('click', handleJaneDecrypt);
        };
        
        function handleJoeGenerate() {
            // Generate a random private key for Joe
            joe.privateKey = generateRandomKey(1, 10);
            document.getElementById('joe-private-key').value = joe.privateKey;

            // Update the internal state and UI with the public key
            joe.publicKey = generatePublicKey(joe.privateKey);
            document.getElementById('joe-public-key').value = joe.publicKey;
            
            // Send the public key to Jane
            document.getElementById('jane-received-public-key').value = joe.publicKey;
            document.getElementById('btn-jane-calculate').disabled = false;

            const logMsg1 = log(`Joe's private key is ${joe.privateKey}.`);
            const logMsg2 = log(`Calculation for public key: (${PRIME_NUMBER_G} * ${joe.privateKey}) mod ${PRIME_NUMBER_P} = ${PRIME_NUMBER_G * joe.privateKey} mod ${PRIME_NUMBER_P} = ${joe.publicKey}.`);
            const logMsg3 = log(`Joe's public key (${joe.publicKey}) has been sent to Jane.`);
            
            showPopup('Keys Generated and Shared!', 'Joe has created his private key and a public key, which has now been shared with Jane.', `${logMsg1}\n${logMsg2}\n${logMsg3}`);
        }
        
        function handleJaneGenerate() {
            // Generate a random private key for Jane
            jane.privateKey = generateRandomKey(1, 10);
            document.getElementById('jane-private-key').value = jane.privateKey;
            
            // Update the internal state and UI with the public key
            jane.publicKey = generatePublicKey(jane.privateKey);
            document.getElementById('jane-public-key').value = jane.publicKey;

            // Send the public key to Joe
            document.getElementById('joe-received-public-key').value = jane.publicKey;
            document.getElementById('btn-joe-calculate').disabled = false;

            const logMsg1 = log(`Jane's private key is ${jane.privateKey}.`);
            const logMsg2 = log(`Calculation for public key: (${PRIME_NUMBER_G} * ${jane.privateKey}) mod ${PRIME_NUMBER_P} = ${PRIME_NUMBER_G * jane.privateKey} mod ${PRIME_NUMBER_P} = ${jane.publicKey}.`);
            const logMsg3 = log(`Jane's public key (${jane.publicKey}) has been sent to Joe.`);
            
            showPopup('Keys Generated and Shared!', 'Jane has created her private key and a public key, which has now been shared with Joe.', `${logMsg1}\n${logMsg2}\n${logMsg3}`);
        }

        function handleJoeCalculate() {
            const janePublicKey = parseInt(document.getElementById('joe-received-public-key').value);
            if (!janePublicKey) {
                const errorLog = log('Please wait for Jane\'s public key to be received.');
                showPopup('Error', 'Please wait for Jane\'s public key to be received.', errorLog);
                return;
            }
            joe.sharedSecret = calculateSharedSecret(janePublicKey, joe.privateKey);
            document.getElementById('joe-shared-secret').value = joe.sharedSecret;
            const logMsg1 = log(`Joe has received Jane's public key (${janePublicKey}) and calculated his shared secret.`);
            const logMsg2 = log(`Calculation for shared secret: (${janePublicKey} * ${joe.privateKey}) mod ${PRIME_NUMBER_P} = ${janePublicKey * joe.privateKey} mod ${PRIME_NUMBER_P} = ${joe.sharedSecret}.`);
            showPopup('Shared Secret Calculated!', `Joe used Jane's public key and his own private key to create a shared secret: ${joe.sharedSecret}.`, `${logMsg1}\n${logMsg2}`);
        }

        function handleJaneCalculate() {
            const joePublicKey = parseInt(document.getElementById('jane-received-public-key').value);
            if (!joePublicKey) {
                const errorLog = log('Please wait for Joe\'s public key to be received.');
                showPopup('Error', 'Please wait for Joe\'s public key to be received.', errorLog);
                return;
            }
            jane.sharedSecret = calculateSharedSecret(joePublicKey, jane.privateKey);
            document.getElementById('jane-shared-secret').value = jane.sharedSecret;
            const logMsg1 = log(`Jane has received Joe's public key (${joePublicKey}) and calculated her shared secret.`);
            const logMsg2 = log(`Calculation for shared secret: (${joePublicKey} * ${jane.privateKey}) mod ${PRIME_NUMBER_P} = ${joePublicKey * jane.privateKey} mod ${PRIME_NUMBER_P} = ${jane.sharedSecret}.`);
            showPopup('Shared Secret Calculated!', `Jane used Joe's public key and her own private key to create a shared secret: ${jane.sharedSecret}.`, `${logMsg1}\n${logMsg2}`);
        }

        function handleJoeEncrypt() {
            if (!joe.sharedSecret) {
                const errorLog = log('Joe must first calculate the shared secret.');
                showPopup('Error', 'Joe must first calculate the shared secret key to encrypt his message.', errorLog);
                return;
            }
            joe.message = document.getElementById('joe-message-input').value;
            if (joe.message.trim() === '') {
                const errorLog = log('Message is empty. Nothing to encrypt.');
                showPopup('Error', 'The message box is empty. Please type a message to encrypt.', errorLog);
                return;
            }
            joe.encryptedMessage = vigenereCipher(joe.message, joe.sharedSecret);
            document.getElementById('joe-encrypted-output').value = joe.encryptedMessage;
            
            // Trigger animation on encrypted message output
            const outputElement = document.getElementById('joe-encrypted-output');
            outputElement.classList.add('animate-encryption');
            // Force a reflow to ensure the animation is triggered
            void outputElement.offsetWidth;
            setTimeout(() => {
                outputElement.classList.remove('animate-encryption');
            }, 1200);

            const logMsg1 = log(`Joe is encrypting the message with the shared secret key of ${joe.sharedSecret}.`);
            const logMsg2 = log(`The shared secret acts like a repeating key for the cipher.`);
            const logMsg3 = log(`Each letter is shifted by a different amount based on its position, repeating the pattern of the key.`);
            showPopup('Message Encrypted!', 'Joe\'s message is now unreadable and encrypted with the shared secret.', `${logMsg1}\n${logMsg2}\n${logMsg3}`);
        }

        function handleJoeSend() {
            if (!joe.encryptedMessage) {
                const errorLog = log('Joe must first encrypt a message.');
                showPopup('Error', 'Please encrypt a message before trying to send it.', errorLog);
                return;
            }
            // Send encrypted message to Jane's input field
            jane.receivedEncrypted = joe.encryptedMessage;
            document.getElementById('jane-received-encrypted').value = jane.receivedEncrypted;
            const logMsg1 = log(`Joe sends his encrypted message to Jane.`);
            const logMsg2 = log(`A potential hacker may only see this encrypted data: "${jane.receivedEncrypted}".`);
            showPopup('Message Sent!', 'The encrypted message has been sent to Jane. Only she can read it!', `${logMsg1}\n${logMsg2}`);
        }

        function handleJoeDecrypt() {
            if (!joe.receivedEncrypted) {
                const errorLog = log('Joe has not received a message to decrypt.');
                showPopup('Error', 'There is no encrypted message to decrypt. Please have Jane send one first.', errorLog);
                return;
            }
            joe.decryptedMessage = vigenereCipher(joe.receivedEncrypted, joe.sharedSecret, true);
            document.getElementById('joe-decrypted-output').value = joe.decryptedMessage;
            const logMsg = log(`Joe decrypted the message from Jane using their shared secret.`);
            showPopup('Message Decrypted!', 'Joe has successfully decrypted the message. He can now read it!', logMsg);
        }
        
        function handleJaneEncrypt() {
            if (!jane.sharedSecret) {
                const errorLog = log('Jane must first calculate the shared secret.');
                showPopup('Error', 'Jane must first calculate the shared secret key to encrypt her message.', errorLog);
                return;
            }
            jane.message = document.getElementById('jane-message-input').value;
            if (jane.message.trim() === '') {
                const errorLog = log('Message is empty. Nothing to encrypt.');
                showPopup('Error', 'The message box is empty. Please type a message to encrypt.', errorLog);
                return;
            }
            jane.encryptedMessage = vigenereCipher(jane.message, jane.sharedSecret);
            document.getElementById('jane-encrypted-output').value = jane.encryptedMessage;

            // Trigger animation on encrypted message output
            const outputElement = document.getElementById('jane-encrypted-output');
            outputElement.classList.add('animate-encryption');
            // Force a reflow to ensure the animation is triggered
            void outputElement.offsetWidth;
            setTimeout(() => {
                outputElement.classList.remove('animate-encryption');
            }, 1200);

            const logMsg1 = log(`Jane is encrypting the message with the shared secret key of ${jane.sharedSecret}.`);
            const logMsg2 = log(`The shared secret acts like a repeating key for the cipher.`);
            const logMsg3 = log(`Each letter is shifted by a different amount based on its position, repeating the pattern of the key.`);
            showPopup('Message Encrypted!', 'Jane\'s message is now unreadable and encrypted with the shared secret.', `${logMsg1}\n${logMsg2}\n${logMsg3}`);
        }

        function handleJaneSend() {
            if (!jane.encryptedMessage) {
                const errorLog = log('Jane must first encrypt a message.');
                showPopup('Error', 'Please encrypt a message before trying to send it.', errorLog);
                return;
            }
            // Send encrypted message to Joe's input field
            joe.receivedEncrypted = jane.encryptedMessage;
            document.getElementById('joe-received-encrypted').value = joe.receivedEncrypted;
            const logMsg1 = log(`Jane sends her encrypted message to Joe.`);
            const logMsg2 = log(`A potential hacker may only see this encrypted data: "${jane.receivedEncrypted}".`);
            showPopup('Message Sent!', 'The encrypted message has been sent to Joe. Only he can read it!', `${logMsg1}\n${logMsg2}`);
        }

        function handleJaneDecrypt() {
            if (!joe.receivedEncrypted) {
                const errorLog = log('Jane has not received a message to decrypt.');
                showPopup('Error', 'There is no encrypted message to decrypt. Please have Joe send one first.', errorLog);
                return;
            }
            jane.decryptedMessage = vigenereCipher(jane.receivedEncrypted, jane.sharedSecret, true);
            document.getElementById('jane-decrypted-output').value = jane.decryptedMessage;
            const logMsg = log(`Jane decrypted the message from Joe using their shared secret.`);
            showPopup('Message Decrypted!', 'Jane has successfully decrypted the message. She can now read it!', logMsg);
        }

        // Animation logic
        const animationContainer = document.getElementById('animation-container');
        const mainContent = document.getElementById('main-content');
        const skipBtn = document.getElementById('skip-btn');
        let currentStepIndex = 0;

        const animationSteps = [
            { title: "E2E Encryption Demo", subtitle: "A simplified demonstration of how end-to-end encryption works." },
            { title: "1. Key Exchange", subtitle: "Joe and Jane agree on a shared secret key without ever sending it." },
            { title: "2. Message Encryption", subtitle: "Joe encrypts a message using the shared secret." },
            { title: "3. Shared Secret", subtitle: "Only the shared secret can unlock the message. An eavesdropper can't read it." },
            { title: "Complete!", subtitle: "The shared secret ensures your messages are safe." }
        ];

        const showStep = (step) => {
            document.getElementById('animation-title').textContent = step.title;
            document.getElementById('animation-subtitle').textContent = step.subtitle;

            const steps = document.querySelectorAll('.animation-step');
            steps.forEach(s => s.classList.remove('active', 'fade-in'));
            if (currentStepIndex === 1) {
                document.getElementById('animation-step-1').classList.add('active', 'fade-in');
            } else if (currentStepIndex === 2) {
                document.getElementById('animation-step-1').classList.remove('active');
                document.getElementById('animation-step-2').classList.add('active', 'fade-in');
            } else if (currentStepIndex === 3) {
                document.getElementById('animation-step-2').classList.remove('active');
                document.getElementById('animation-step-3').classList.add('active', 'fade-in');
            } else if (currentStepIndex === 4) {
                document.getElementById('animation-step-3').classList.remove('active');
                document.getElementById('animation-step-4').classList.add('active', 'fade-in');
            } else {
                document.getElementById('animation-step-1').classList.remove('active');
                document.getElementById('animation-step-2').classList.remove('active');
                document.getElementById('animation-step-3').classList.remove('active');
                document.getElementById('animation-step-4').classList.remove('active');
            }
        };

        const startAnimation = () => {
            animationContainer.classList.remove('hidden');
            animationContainer.style.display = 'flex';
            
            // Step 1: Initial Intro
            showStep(animationSteps[currentStepIndex]);

            // Step 2: Key Exchange
            setTimeout(() => {
                currentStepIndex++;
                showStep(animationSteps[currentStepIndex]);
                setTimeout(() => {
                    document.getElementById('plus-icon-1').classList.remove('opacity-0');
                    document.getElementById('equals-icon-1').classList.remove('opacity-0');
                    document.getElementById('secret-key-icon-1').classList.remove('opacity-0');
                }, 1000);
            }, 3000);

            // Step 3: Message Encryption
            setTimeout(() => {
                currentStepIndex++;
                showStep(animationSteps[currentStepIndex]);
            }, 6000);

            // Step 4: Shared Secret
            setTimeout(() => {
                currentStepIndex++;
                showStep(animationSteps[currentStepIndex]);
                setTimeout(() => {
                    const encryptedIcon = document.getElementById('encrypted-message-icon');
                    encryptedIcon.classList.remove('opacity-0', 'scale-0');
                    encryptedIcon.classList.add('opacity-100', 'scale-100');
                }, 1000);
            }, 9000);
            
            // Step 5: Final Call to Action
            setTimeout(() => {
                currentStepIndex++;
                showStep(animationSteps[currentStepIndex]);
            }, 12000);

            // End of animation
            setTimeout(() => {
                skipAnimation();
            }, 15000);
        };

        const skipAnimation = () => {
            animationContainer.classList.add('hidden');
            setTimeout(() => {
                animationContainer.style.display = 'none';
                mainContent.classList.remove('hidden');
                document.getElementById('joe-message-input').value = "Hi, how are you?";
                document.getElementById('jane-message-input').value = "Fine. How are you?";
                setupEventListeners();
            }, 500);
        };

        skipBtn.addEventListener('click', skipAnimation);
        
        window.onload = () => {
            startAnimation();
        };

    </script>
</body>
</html>
